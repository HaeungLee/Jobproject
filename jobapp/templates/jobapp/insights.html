{% extends "jobapp/base.html" %}
{% load static %}

{% block title %}ì±„ìš© ì¸ì‚¬ì´íŠ¸ - ì±„ìš©ì •ë³´ ë¶„ì„ ì•±{% endblock %}

{% block content %}
<header class="insights-header text-center">
    <h1>ê°œë°œì ì±„ìš© ì¸ì‚¬ì´íŠ¸</h1>
    <p class="lead">AI ë° ì›¹ ê°œë°œ ì§ë¬´ ì±„ìš© ì‹œì¥ ë¶„ì„</p>
    <div class="text-center mb-3">
        <span class="badge bg-primary p-2">ì´ ì±„ìš© ê³µê³  ìˆ˜: {{ total_jobs }}</span>
        <span class="badge bg-info p-2">ë°ì´í„° ì†ŒìŠ¤: {{ data_source }}{% if file_name %} ({{ file_name }}){% endif %}</span>
    </div>
</header>

<!-- ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ ë¶€ë¶„ ì¶”ê°€ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ</h5>
                <div>
                    <a href="{% url 'jobapp:job_insights' %}?data_source=db" class="btn btn-sm btn-outline-primary {% if data_source == 'DB' %}active{% endif %}">
                        ë°ì´í„°ë² ì´ìŠ¤
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        {% if backup_files %}
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ë°±ì—… íŒŒì¼</th>
                                        <th>í¬ê¸°</th>
                                        <th>ìƒì„± ë‚ ì§œ</th>
                                        <th>ì•¡ì…˜</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in backup_files %}
                                    <tr>
                                        <td>{{ file.name }}</td>
                                        <td>{{ file.size }}</td>
                                        <td>{{ file.date }}</td>
                                        <td>
                                            <a href="{% url 'jobapp:job_insights' %}?data_source=file&file_path={{ file.path }}" 
                                               class="btn btn-sm btn-primary">
                                                ì´ íŒŒì¼ë¡œ ë¶„ì„
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <div class="alert alert-warning">
                                ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í¬ë¡¤ë§ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ë•Œ <code>--backup-format</code> ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë°±ì—… íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ì¸ì‚¬ì´íŠ¸ ìš”ì•½</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>ğŸ” ì±„ìš© íŠ¸ë Œë“œ:</strong> {{ trend_insight }}
                    </li>
                    <li class="list-group-item">
                        <strong>ğŸŒ ì§€ì—­ë³„ í˜„í™©:</strong> {{ location_insight }}
                    </li>
                    <li class="list-group-item">
                        <strong>ğŸ’¼ ê²½ë ¥ ìš”êµ¬ì‚¬í•­:</strong> {{ career_insight }}
                    </li>
                    <li class="list-group-item">
                        <strong>ğŸ“ í•™ë ¥ ìš”êµ¬ì‚¬í•­:</strong> {{ education_insight }}
                    </li>
                    <li class="list-group-item">
                        <strong>ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ:</strong> {{ skill_insight }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Matplotlib/Seaborn ê·¸ë˜í”„ í‘œì‹œ ì˜ì—­ -->
<div class="row mb-4">
    {% if trend_graph %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>ì±„ìš© ê³µê³  ì¶”ì´</h5>
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ trend_graph }}" class="img-fluid" alt="ì±„ìš© ê³µê³  ì¶”ì´">
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if career_skill_graph %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>ê²½ë ¥ë³„ ìŠ¤í‚¬ ìš”êµ¬ì‚¬í•­ ê°¯ìˆ˜</h5>
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ career_skill_graph }}" class="img-fluid" alt="ê²½ë ¥ë³„ ìŠ¤í‚¬ ìš”êµ¬ì‚¬í•­ ê°¯ìˆ˜">
            </div>
        </div>
    </div>
    {% endif %}
</div>


<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>ê°œë°œ ë¶„ì•¼ë³„ ì±„ìš© ë¹„êµ</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="devFieldChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>ê°€ì¥ ë§ì´ ìš”êµ¬ë˜ëŠ” ê¸°ìˆ  ìŠ¤íƒ</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="skillChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>ì§ë¬´ ë¶„ì•¼ë³„ ì±„ìš© ë¶„í¬</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="jobFieldChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>ì§€ì—­ë³„ ì±„ìš© í˜„í™©</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="locationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>ê²½ë ¥ ìˆ˜ì¤€ë³„ ë¶„í¬</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="careerChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>í•™ë ¥ ìš”êµ¬ì‚¬í•­ ë¶„í¬</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="educationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì§ë¬´ ë¶„ì•¼ë³„ ì±„ìš© ë¶„í¬ ì°¨íŠ¸
        const jobFieldData = {{ job_field_data_json|safe }};
        new Chart(document.getElementById('jobFieldChart'), {
            type: 'bar',
            data: {
                labels: jobFieldData.labels,
                datasets: [{
                    label: 'ì±„ìš© ê³µê³  ìˆ˜',
                    data: jobFieldData.data,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // ì§€ì—­ë³„ ì±„ìš© í˜„í™© ì°¨íŠ¸
        const locationData = {{ location_data_json|safe }};
        new Chart(document.getElementById('locationChart'), {
            type: 'pie',
            data: {
                labels: locationData.labels,
                datasets: [{
                    data: locationData.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(199, 199, 199, 0.7)',
                        'rgba(83, 102, 255, 0.7)',
                        'rgba(40, 159, 64, 0.7)',
                        'rgba(210, 199, 199, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // ê²½ë ¥ ìˆ˜ì¤€ë³„ ë¶„í¬ ì°¨íŠ¸
        const careerData = {{ career_data_json|safe }};
        new Chart(document.getElementById('careerChart'), {
            type: 'doughnut',
            data: {
                labels: careerData.labels,
                datasets: [{
                    data: careerData.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // í•™ë ¥ ìš”êµ¬ì‚¬í•­ ë¶„í¬ ì°¨íŠ¸
        const educationData = {{ education_data_json|safe }};
        new Chart(document.getElementById('educationChart'), {
            type: 'doughnut',
            data: {
                labels: educationData.labels,
                datasets: [{
                    data: educationData.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // ê°œë°œ ë¶„ì•¼ë³„ ì±„ìš© ë¹„êµ ì°¨íŠ¸
        const devFieldData = {{ dev_field_comparison_json|safe }};
        new Chart(document.getElementById('devFieldChart'), {
            type: 'polarArea',
            data: {
                labels: devFieldData.labels,
                datasets: [{
                    data: devFieldData.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // ìŠ¤í‚¬ ì°¨íŠ¸
        const skillData = {{ skill_data_json|safe }};
        new Chart(document.getElementById('skillChart'), {
            type: 'horizontalBar',
            data: {
                labels: skillData.labels,
                datasets: [{
                    label: 'ì–¸ê¸‰ íšŸìˆ˜',
                    data: skillData.data,
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}